üöÄ LANGKAH DEPLOY PRODUCTION KEY + ENHANCED SECURITY
======================================================

## ‚ö†Ô∏è PENTING: Update Netlify Environment Variable Dulu!

### STEP 1: Update Netlify Environment Variable

**WAJIB dilakukan sebelum deploy!**

1. **Buka Netlify Dashboard:**
   https://app.netlify.com

2. **Pilih site:** 4leafclover.id

3. **Masuk ke Settings:**
   Site settings ‚Üí Environment variables

4. **Edit variable:**
   - Cari: `VITE_RECAPTCHA_SITE_KEY`
   - Klik "Edit"
   - Ganti value dengan: `6Lf49T8sAAAAABpJ7AT8oV9JFNZw8rTQ6GxzTJt5`
   - Save

5. **Trigger Redeploy:**
   - Deploys ‚Üí Trigger deploy ‚Üí Deploy site
   - Atau tunggu auto-deploy dari GitHub push

---

## STEP 2: Commit & Push ke GitHub

```bash
# Add semua perubahan
git add -A

# Commit dengan pesan yang jelas
git commit -m "fix: revert to production reCAPTCHA key with enhanced security

- Kembalikan ke production reCAPTCHA key (secure)
- Tambah IP blacklist untuk block spam
- Tambah token format validation
- Tambah hostname verification
- Tambah token age check (max 2 menit)
- Enhanced logging untuk monitoring
- Rate limiter dengan logging
- Multi-layer protection tetap aktif"

# Push ke GitHub
git push origin main
```

---

## STEP 3: Deploy Backend ke VPS

### Option A: Pakai Script (Recommended)

```bash
# SSH ke VPS
ssh root@43.228.213.128

# Jalankan script
bash /root/n8n-production/portfolio/scripts/deploy-production-recaptcha.sh
```

### Option B: Manual

```bash
# SSH ke VPS
ssh root@43.228.213.128

# Masuk ke project folder
cd /root/n8n-production/portfolio

# Pull latest code
git pull origin main

# Restart backend
docker compose restart backend

# Check logs
docker logs portfolio-backend --tail 50 -f
```

---

## STEP 4: Verifikasi Deployment

### A. Check Backend Logs

```bash
docker logs portfolio-backend --tail 100 -f
```

**Look for:**
- ‚úÖ Server started successfully
- ‚úÖ Database connected
- ‚úÖ No errors

### B. Check Frontend Deployment

1. Buka Netlify Dashboard
2. Deploys ‚Üí Check status
3. Tunggu sampai "Published" (2-3 menit)

### C. Test Contact Form

1. Buka: https://4leafclover.id
2. Scroll ke Contact section
3. Isi form dengan data valid
4. Centang reCAPTCHA checkbox
5. Solve puzzle (kalau muncul)
6. Submit ‚Üí Harus success!

---

## STEP 5: Testing Scenarios

### Test 1: Normal User ‚úÖ
```
1. Isi form dengan data valid
2. Centang reCAPTCHA
3. Solve puzzle (kalau ada)
4. Submit
Expected: Success!
```

### Test 2: Bot dengan Token Fake ‚ùå
```bash
curl -X POST https://api.4leafclover.id/api/messages \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Bot",
    "email": "bot@spam.com",
    "message": "Spam",
    "recaptchaToken": "fake-token"
  }'
```
Expected: 400 Bad Request

### Test 3: Rate Limiting ‚ùå
```
1. Kirim pesan 1 ‚Üí Success
2. Kirim pesan 2 ‚Üí Success
3. Kirim pesan 3 ‚Üí Success
4. Kirim pesan 4 ‚Üí 429 Too Many Requests
```

### Test 4: Submit Terlalu Cepat ‚ùå
```
1. Buka form
2. Langsung submit (< 3 detik)
Expected: "Please take your time"
```

---

## STEP 6: Monitoring

### A. Monitor Backend Logs

```bash
# Real-time logs
docker logs portfolio-backend --tail 100 -f

# Check for suspicious activity
docker logs portfolio-backend | grep "‚ö†Ô∏è"
docker logs portfolio-backend | grep "Blocked"
docker logs portfolio-backend | grep "Invalid"
```

### B. Monitor Admin Panel

1. Login: https://4leafclover.id/admin
2. Menu: Messages
3. Check pesan yang masuk
4. Delete spam kalau ada
5. Catat IP spam

### C. Check Netlify Logs

1. Netlify Dashboard
2. Functions ‚Üí Check errors
3. Analytics ‚Üí Check traffic

---

## STEP 7: Kalau Ada Spam

### Identifikasi IP Spam

Dari backend logs:
```
‚ö†Ô∏è Rate limit exceeded for IP: 123.456.789.0
‚ö†Ô∏è Invalid reCAPTCHA token from IP: 123.456.789.0
```

### Tambahkan ke Blacklist

1. **Edit file:**
   `backend/src/middleware/recaptchaVerify.js`

2. **Tambahkan IP:**
```javascript
const BLACKLISTED_IPS = new Set([
  '123.456.789.0', // Spam bot - 2026-01-04
  '111.222.333.444', // Another spam - 2026-01-04
]);
```

3. **Commit & Deploy:**
```bash
git add backend/src/middleware/recaptchaVerify.js
git commit -m "chore: add spam IPs to blacklist"
git push origin main

# SSH ke VPS
ssh root@43.228.213.128
cd /root/n8n-production/portfolio
git pull
docker compose restart backend
```

---

## üìä EXPECTED RESULTS:

### Setelah Deploy:

**Frontend:**
- ‚úÖ Production reCAPTCHA key aktif
- ‚úÖ Puzzle muncul untuk bot
- ‚úÖ User normal tidak terganggu
- ‚úÖ Honeypot field aktif
- ‚úÖ Time validation aktif

**Backend:**
- ‚úÖ Token fake akan di-reject
- ‚úÖ Hostname verification aktif
- ‚úÖ Token age check aktif
- ‚úÖ IP blacklist aktif
- ‚úÖ Enhanced logging aktif
- ‚úÖ Rate limiting aktif

**Result:**
- ‚úÖ Spam akan berhenti
- ‚úÖ Bot tidak bisa bypass
- ‚úÖ User experience lebih baik
- ‚úÖ Security lebih kuat

---

## üÜò TROUBLESHOOTING:

### Problem: Netlify env variable tidak update

**Solution:**
1. Clear build cache di Netlify
2. Trigger redeploy
3. Check environment variables lagi

### Problem: Backend tidak restart

**Solution:**
```bash
docker compose down
docker compose up -d
docker logs portfolio-backend --tail 50 -f
```

### Problem: reCAPTCHA tidak muncul

**Solution:**
1. Clear browser cache
2. Hard refresh (Ctrl + Shift + R)
3. Check Netlify env variable
4. Check browser console for errors

### Problem: Spam masih masuk

**Solution:**
1. Check backend logs untuk IP spam
2. Tambahkan IP ke blacklist
3. Check apakah reCAPTCHA verification berjalan
4. Verify production key sudah benar

---

## ‚úÖ CHECKLIST:

Sebelum deploy, pastikan:
- [ ] Netlify env variable sudah diupdate
- [ ] Code sudah di-commit
- [ ] Code sudah di-push ke GitHub
- [ ] Backend sudah di-restart di VPS
- [ ] Frontend sudah deployed di Netlify
- [ ] Contact form sudah di-test
- [ ] Logs sudah di-monitor
- [ ] Admin panel sudah di-check

Setelah deploy:
- [ ] Test normal user flow
- [ ] Test bot dengan token fake
- [ ] Test rate limiting
- [ ] Monitor logs selama 24 jam
- [ ] Check admin panel untuk spam
- [ ] Tambah IP ke blacklist kalau perlu

---

## üìû NEXT STEPS:

1. **Update Netlify env variable** (WAJIB!)
2. **Commit & push** code ke GitHub
3. **Deploy backend** ke VPS
4. **Test** contact form
5. **Monitor** logs & admin panel
6. **Block IP spam** kalau ada

**Spam akan berhenti dengan solusi ini!** üéØ
